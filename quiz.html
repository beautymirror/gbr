<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Your Score - Global Beauty Rank</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F7F7F8; overflow: hidden; }
        .logo-gradient-text { background: linear-gradient(90deg, #D946EF, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .cta-button { background: linear-gradient(90deg, #D946EF, #8B5CF6); color: white; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .cta-button:hover { box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.5), 0 0 15px rgba(217, 70, 239, 0.3); transform: translateY(-3px) scale(1.05); }
        .cta-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        #visual-panel { background: linear-gradient(135deg, #f5f3ff 0%, #eef2ff 100%); }
        .visual-content { transition: opacity 0.5s ease-in-out; position: absolute; }
        .chat-bubble-wrapper { animation: fadeIn 0.5s ease-in-out forwards; }
        .bot-bubble { background-color: #eef2ff; color: #4338ca; }
        .user-bubble { background: linear-gradient(90deg, #D946EF, #8B5CF6); color: white; }
        .input-option:hover { background-color: #f5f3ff; border-color: #8B5CF6; }
        .input-option.selected { border-color: #8B5CF6; background-color: #F5F3FF; color: #6D28D9; box-shadow: 0 0 0 2px #C4B5FD; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes typing { 0% { content: "."; } 33% { content: ".."; } 66% { content: "..."; } 100% { content: "."; } }
        .typing-indicator::after { content: '.'; animation: typing 1.5s infinite; }
    </style>
</head>
<body class="text-gray-900">
    <main class="w-screen h-screen grid grid-cols-1 md:grid-cols-2">
        <!-- Left Visual Panel -->
        <div id="visual-panel" class="hidden md:flex items-center justify-center p-8 relative overflow-hidden">
            <div id="visual-welcome" class="visual-content text-center opacity-100"><img src="welcome.svg" alt="Welcome Illustration" class="w-[34rem] h-[34rem] mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/544x544/E9D5FF/4C1D95?text=Welcome';"><h2 class="text-3xl font-bold text-gray-700">Global Beauty Rank</h2><p class="text-gray-500 mt-2">Discover your beauty score with our AI.</p></div>
            <div id="visual-data" class="visual-content text-center opacity-0 hidden"><img src="data-form.svg" alt="Data Input Illustration" class="w-[34rem] h-[34rem] mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/544x544/E9D5FF/4C1D95?text=Data';"><h2 class="text-3xl font-bold text-gray-700">Just a few questions...</h2><p class="text-gray-500 mt-2">This will help us determine your score more accurately.</p></div>
            <div id="visual-upload" class="visual-content text-center opacity-0 hidden"><img src="selfie-upload.svg" alt="Upload Selfie Illustration" class="w-[34rem] h-[34rem] mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/544x544/E9D5FF/4C1D95?text=Upload';"><h2 class="text-3xl font-bold text-gray-700">Time for a selfie!</h2><p class="text-gray-500 mt-2">Upload a photo where your face is clearly visible.</p></div>
            <img id="image-preview" class="visual-content max-h-full max-w-full object-contain rounded-2xl shadow-lg opacity-0 hidden" />
        </div>
        <!-- Right Chat Panel -->
        <div class="w-full h-screen flex flex-col bg-white">
            <div class="p-4 border-b border-gray-200"><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-bar-fill" class="bg-gradient-to-r from-pink-500 to-purple-500 h-2.5 rounded-full transition-width duration-500" style="width: 0%"></div></div></div>
            <div id="chat-log" class="flex-grow p-6 space-y-6 overflow-y-auto"></div>
            <div id="input-area" class="p-4 border-t border-gray-200 bg-gray-50"></div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ВАЖНО: Вставьте сюда вашу конфигурацию Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD9R43D9ktWxYFQtpkGJNTOgdWyZqfM-bU",
            authDomain: "global-beauty-rank.firebaseapp.com",
            projectId: "global-beauty-rank",
            storageBucket: "global-beauty-rank.firebasestorage.app",
            messagingSenderId: "916586590476",
            appId: "1:916586590476:web:039be613c177dc46491929",
            measurementId: "G-KPWTDXMHF"
        };
        
        // Инициализируем Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ИЗМЕНЕНИЕ: Вставлен ваш публичный ключ Stripe
        const STRIPE_PUBLISHABLE_KEY = "pk_live_51PQ7mLA19LNOHDEO1yMYpJ3B74vO6GdJD0No0qRpsDBo5Xw956DxQMayJWUZjlNEo6S1WdEWY2Hr6ysFkLI4386I00vkmegPBL";

        // Используем относительные пути.
        const createPaymentIntentUrl = `/.netlify/functions/createPaymentIntent`;
        const analyzeImageUrl = `/.netlify/functions/analyzeImage`;

        const chatLog = document.getElementById('chat-log');
        const inputArea = document.getElementById('input-area');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const imagePreview = document.getElementById('image-preview');

        let currentStep = 0;
        const userData = { base64Image: null };
        let stripe, elements, cardElement;

        const quizSteps = [
            { id: 'welcome', type: 'message', text: "Hello! I'm your personal AI assistant. Ready to discover your beauty score?" },
            { id: 'privacy', type: 'message', text: "Great! But first, something important: your photos are only used for analysis and are deleted immediately after calculation. Your privacy is guaranteed." },
            { id: 'disclaimer', type: 'choice', text: "And remember: this score is the result of an algorithm, not a verdict. Everyone is beautiful in their own way. Do you agree?", options: [{ text: 'I understand and agree', value: 'agree' }] },
            { id: 'terms', type: 'choice', text: 'Please review our <a href="terms.html" target="_blank" class="underline text-indigo-500 hover:text-indigo-400">Terms of Service</a> and <a href="policy.html" target="_blank" class="underline text-indigo-500 hover:text-indigo-400">Privacy Policy</a> before we continue.', options: [{ text: 'I agree and continue', value: 'agree' }] },
            { id: 'name', type: 'text', text: "Perfect! Let's get started. What's your name?" },
            { id: 'name_greeting', type: 'message', text: 'Nice to meet you, ' },
            { id: 'gender', type: 'choice', text: "Got it. Now, please select your gender.", options: [{ text: 'Male', value: 'male' }, { text: 'Female', value: 'female' }] },
            { id: 'age', type: 'select', text: "Thank you. And your age range?", options: ['Under 18', '18-25', '25-35', '36-44', '45-59', '60+'] },
            { id: 'upload', type: 'file', text: "Super! Now, please upload your best selfie. Make sure your face is clearly visible, without glasses or heavy makeup." },
            { id: 'upload_compliment', type: 'message', text: 'Wow, you are very beautiful! Now for the final step.' },
            { id: 'payment', type: 'payment', text: 'Almost done. The last step is a secure payment.' },
            { id: 'calculating', type: 'message', text: "Thank you! Sending your photo to the neural network for analysis... This may take a few seconds." },
            { id: 'result', type: 'result' }
        ];
        
        async function getAIScore() {
            if (!userData.base64Image) {
                await addBotMessage("It seems there was an error with the photo upload. Please try again.", true);
                return;
            }
            
            try {
                const response = await fetch(analyzeImageUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: userData.base64Image, userData: userData })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Function Error: ${response.statusText} - ${errorData.error}`);
                }

                const aiResult = await response.json();
                
                renderResult(aiResult);

            } catch (error) {
                console.error("AI Score Error:", error);
                await addBotMessage("Unfortunately, the AI analyzer is not responding right now. Please try again a little later.", true);
                renderResult({score: '?', rank: 'Analysis Error'});
            }
        }
        
        async function renderPayment() {
            const container = document.createElement('div');
            container.className = 'flex items-start gap-3 chat-bubble-wrapper self-start';
            const avatar = document.createElement('img');
            avatar.src = 'avatar.svg';
            avatar.alt = 'bot avatar';
            avatar.className = 'w-10 h-10 rounded-full border-2 border-purple-100';
            avatar.onerror = () => { avatar.style.display = 'none'; };
            const paymentBubble = document.createElement('div');
            paymentBubble.className = 'bot-bubble max-w-md p-4 sm:p-6 rounded-2xl rounded-bl-lg w-full';
            const form = document.createElement('form');
            form.id = 'payment-form';
            form.innerHTML = `<div class="flex justify-between items-start"><div><h3 class="font-bold text-lg text-indigo-800">Your Price</h3></div><div class="text-right"><p class="text-2xl font-bold text-indigo-800" id="payment-amount-display">...</p></div></div><div class="my-4 space-y-3"><div id="payment-request-button"></div><div id="card-element" class="bg-white p-3 rounded-lg border border-indigo-200"></div></div><div id="card-errors" role="alert" class="text-red-500 text-sm mt-2 h-4"></div><button id="submit-payment" class="w-full mt-4 cta-button font-bold text-lg px-8 py-3 rounded-xl"><span>Pay and get result</span></button>`;
            paymentBubble.appendChild(form);
            container.appendChild(avatar);
            container.appendChild(paymentBubble);
            chatLog.appendChild(container);
            scrollToBottom();

            try {
                stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                const response = await fetch(createPaymentIntentUrl, { 
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }

                const paymentData = await response.json();
                if (!paymentData || !paymentData.clientSecret) {
                    throw new Error("Invalid response from server");
                }
                const { clientSecret, amount, currency, countryCode, countryName } = paymentData;
                
                userData.country = countryName;

                const formattedPrice = new Intl.NumberFormat('en-US', { style: 'currency', currency: currency.toUpperCase() }).format(amount / 100);
                document.getElementById('payment-amount-display').textContent = formattedPrice;
                document.querySelector('#submit-payment span').textContent = `Pay ${formattedPrice}`;

                const paymentRequest = stripe.paymentRequest({
                    country: countryCode,
                    currency: currency.toLowerCase(),
                    total: {
                        label: 'Beauty Analysis',
                        amount: amount,
                    },
                    requestPayerName: true,
                    requestPayerEmail: true,
                });

                elements = stripe.elements();
                const prButton = elements.create('paymentRequestButton', {
                    paymentRequest,
                });

                const canMakePayment = await paymentRequest.canMakePayment();
                if (canMakePayment) {
                    prButton.mount('#payment-request-button');
                    document.getElementById('card-element').style.display = 'none';
                    document.getElementById('submit-payment').style.display = 'none';
                } else {
                    cardElement = elements.create('card');
                    cardElement.mount('#card-element');
                    document.getElementById('payment-request-button').style.display = 'none';
                }

                paymentRequest.on('paymentmethod', async (ev) => {
                    const { paymentIntent, error: confirmError } = await stripe.confirmCardPayment(
                        clientSecret,
                        { payment_method: ev.paymentMethod.id },
                        { handleActions: false }
                    );

                    if (confirmError) {
                        ev.complete('fail');
                    } else {
                        ev.complete('success');
                        if (paymentIntent.status === "requires_action") {
                            const { error } = await stripe.confirmCardPayment(clientSecret);
                            if (error) {
                                addBotMessage("Payment failed. Please try again.", true);
                            } else {
                                proceedToNextStep({ payment: 'success' }, 'Payment successful');
                            }
                        } else {
                            proceedToNextStep({ payment: 'success' }, 'Payment successful');
                        }
                    }
                });

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const submitButton = document.getElementById('submit-payment');
                    submitButton.disabled = true;
                    submitButton.innerHTML = `<div class="animate-spin h-5 w-5 mx-auto border-2 border-white border-t-transparent rounded-full"></div>`;
                    
                    const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                        payment_method: {
                            card: cardElement,
                        },
                    });

                    if (error) {
                        document.getElementById('card-errors').textContent = error.message;
                        submitButton.disabled = false;
                        submitButton.innerHTML = `<span>Pay ${formattedPrice}</span>`;
                    } else if (paymentIntent.status === 'succeeded') {
                        proceedToNextStep({ payment: 'success' }, 'Payment successful');
                    }
                });

            } catch (error) {
                console.error("Error initializing payment:", error);
                addBotMessage("Could not initialize payment. Please check your configuration and try again later.", true);
            }
        }
        
        async function checkPaymentStatus() {
            const clientSecret = new URLSearchParams(window.location.search).get(
                "payment_intent_client_secret"
            );

            if (!clientSecret) {
                return;
            }
            
            if (!stripe) {
                stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
            }

            const { paymentIntent } = await stripe.retrievePaymentIntent(clientSecret);

            if (paymentIntent.status === 'succeeded') {
                currentStep = quizSteps.findIndex(step => step.id === 'calculating');
                const savedUserData = localStorage.getItem('userData');
                if(savedUserData) {
                    Object.assign(userData, JSON.parse(savedUserData));
                }
                handleStep();
            }
        }

        function updateVisualPanel(stepId) {
            document.querySelectorAll('.visual-content').forEach(el => {
                el.classList.add('opacity-0', 'hidden');
            });
            imagePreview.classList.add('opacity-0', 'hidden');
            let activeVisualId;
            if (['welcome', 'privacy', 'disclaimer', 'terms'].includes(stepId)) {
                activeVisualId = 'visual-welcome';
            } else if (['name', 'gender', 'age'].includes(stepId)) {
                activeVisualId = 'visual-data';
            } else if (stepId === 'upload') {
                activeVisualId = 'visual-upload';
            } else {
                activeVisualId = 'image-preview';
            }
            const activeVisual = document.getElementById(activeVisualId);
            if (activeVisual) {
                activeVisual.classList.remove('hidden');
                setTimeout(() => {
                    activeVisual.classList.remove('opacity-0');
                }, 10);
            }
        }
        function updateProgress() {
            const percent = (currentStep / (quizSteps.length - 1)) * 100;
            progressBarFill.style.width = `${percent}%`;
        }
        function scrollToBottom() {
            setTimeout(() => {
                chatLog.scrollTop = chatLog.scrollHeight;
            }, 0);
        }
        function showTypingIndicator() {
            const container = document.createElement('div');
            container.id = 'typing-indicator';
            container.className = 'flex items-start gap-3 chat-bubble-wrapper self-start';
            container.innerHTML = `<img src="avatar.svg" alt="bot avatar" class="w-10 h-10 rounded-full border-2 border-purple-100" onerror="this.style.display='none'"><div class="bot-bubble p-3 rounded-2xl rounded-bl-lg"><div class="typing-indicator"></div></div>`;
            chatLog.appendChild(container);
            scrollToBottom();
        }
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }
        function disableInputs() {
            inputArea.innerHTML = '';
        }
        function addBotMessage(text, isError = false) {
            return new Promise(resolve => {
                showTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();
                    const container = document.createElement('div');
                    container.className = 'flex items-start gap-3 chat-bubble-wrapper self-start';
                    const avatar = document.createElement('img');
                    avatar.src = 'avatar.svg';
                    avatar.alt = 'bot avatar';
                    avatar.className = 'w-10 h-10 rounded-full border-2 border-purple-100';
                    avatar.onerror = () => { avatar.style.display = 'none'; };
                    const bubble = document.createElement('div');
                    bubble.className = `bot-bubble max-w-md p-4 rounded-2xl rounded-bl-lg text-lg ${isError ? 'bg-red-100 text-red-700' : ''}`;
                    bubble.innerHTML = text;
                    container.appendChild(avatar);
                    container.appendChild(bubble);
                    chatLog.appendChild(container);
                    scrollToBottom();
                    resolve();
                }, 1000 + Math.random() * 500);
            });
        }
        function addUserMessage(text) {
             const bubble = document.createElement('div');
             bubble.className = 'user-bubble self-end max-w-md p-4 rounded-2xl rounded-br-lg text-lg chat-bubble-wrapper';
             bubble.textContent = text;
             chatLog.appendChild(bubble);
             scrollToBottom();
        }
        async function handleStep() {
            if (currentStep >= quizSteps.length) return;
            updateProgress();
            const step = quizSteps[currentStep];
            disableInputs();
            updateVisualPanel(step.id);
            if (step.type === 'result') {
                await getAIScore();
                localStorage.removeItem('userData');
                return;
            }
            let messageText = step.text;
            if (step.id === 'name_greeting') {
                messageText = `${step.text}${userData.name}!`;
            }
            await addBotMessage(messageText);
            switch (step.type) {
                case 'choice': renderChoices(step.options); break;
                case 'select': renderSelect(step.options); break;
                case 'text': renderTextInput(); break;
                case 'file': renderFileUpload(); break;
                case 'payment': renderPayment(); break;
                case 'message': default: currentStep++; setTimeout(handleStep, 500); break;
            }
        }
        function proceedToNextStep(data, displayText) {
            const step = quizSteps[currentStep];
            userData[step.id] = data;
            
            if(step.id === 'upload') {
                localStorage.setItem('userData', JSON.stringify(userData));
            }

            if (displayText) {
                addUserMessage(displayText);
            }
            currentStep++;
            setTimeout(handleStep, 500);
        }
        function renderChoices(options) {
            const container = document.createElement('div');
            container.className = 'flex flex-wrap gap-3 justify-center';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'input-option bg-white border-2 border-gray-300 rounded-lg px-6 py-3 font-semibold text-gray-700';
                button.textContent = option.text;
                button.onclick = () => {
                    document.querySelectorAll('.input-option').forEach(btn => btn.disabled = true);
                    button.classList.add('selected');
                    proceedToNextStep(option.value, option.text);
                };
                container.appendChild(button);
            });
            inputArea.appendChild(container);
        }
        function renderSelect(options) {
            const select = document.createElement('select');
            select.className = 'w-full p-4 border border-gray-300 rounded-lg text-lg bg-white focus:ring-2 focus:ring-purple-400 focus:border-purple-400';
            const placeholder = document.createElement('option');
            placeholder.value = "";
            placeholder.textContent = "Select...";
            placeholder.disabled = true;
            placeholder.selected = true;
            select.appendChild(placeholder);
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            select.onchange = () => {
                if (select.value) {
                    proceedToNextStep(select.value, select.value);
                }
            };
            inputArea.appendChild(select);
        }
        
        function renderTextInput() {
            const form = document.createElement('form');
            form.className = 'flex gap-2';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Enter your name...';
            input.className = 'w-full p-4 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400';
            input.required = true;
            const button = document.createElement('button');
            button.type = 'submit';
            button.className = 'cta-button font-bold text-lg px-6 py-3 rounded-xl';
            button.textContent = 'Next';
            form.appendChild(input);
            form.appendChild(button);
            form.onsubmit = (e) => {
                e.preventDefault();
                const name = input.value.trim();
                if (name) {
                    proceedToNextStep(name, name);
                }
            };
            inputArea.appendChild(form);
            input.focus();
        }
        function renderFileUpload() {
            const container = document.createElement('div');
            container.className = 'grid sm:grid-cols-2 gap-3';
            const uploadLabel = document.createElement('label');
            uploadLabel.htmlFor = 'selfie-upload';
            uploadLabel.className = 'w-full cta-button font-bold text-lg px-6 py-4 rounded-xl inline-flex items-center justify-center cursor-pointer';
            uploadLabel.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg> Upload Photo`;
            const cameraButton = document.createElement('button');
            cameraButton.className = 'w-full bg-white border-2 border-gray-300 rounded-lg px-6 py-4 font-semibold text-gray-700 inline-flex items-center justify-center';
            cameraButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Open Camera`;
            cameraButton.onclick = openCamera;
            const fileInput = document.createElement('input');
            fileInput.id = 'selfie-upload';
            fileInput.type = 'file';
            fileInput.className = 'hidden';
            fileInput.accept = 'image/*';
            fileInput.onchange = () => {
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        userData.base64Image = e.target.result.split(',')[1]; 
                        updateVisualPanel('image-preview');
                    }
                    reader.readAsDataURL(fileInput.files[0]);
                    proceedToNextStep(fileInput.files[0], fileInput.files[0].name);
                }
            };
            container.appendChild(uploadLabel);
            container.appendChild(cameraButton);
            inputArea.appendChild(container);
            inputArea.appendChild(fileInput);
        }
        function openCamera() {
            disableInputs();
            const videoContainer = document.createElement('div');
            videoContainer.className = 'relative w-full aspect-video bg-black rounded-lg overflow-hidden';
            videoContainer.innerHTML = `<video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video><canvas id="camera-canvas" class="hidden"></canvas>`;
            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'grid grid-cols-2 gap-3 mt-2';
            const snapButton = document.createElement('button');
            snapButton.className = 'w-full cta-button font-bold text-lg px-6 py-4 rounded-xl';
            snapButton.textContent = 'Take Photo';
            const cancelButton = document.createElement('button');
            cancelButton.className = 'w-full bg-gray-200 text-gray-700 font-bold text-lg px-6 py-4 rounded-xl';
            cancelButton.textContent = 'Cancel';
            controlsContainer.appendChild(cancelButton);
            controlsContainer.appendChild(snapButton);
            inputArea.appendChild(videoContainer);
            inputArea.appendChild(controlsContainer);
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('camera-canvas');
            let stream = null;
            const cleanup = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                renderFileUpload();
            };
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                    .then(s => {
                        stream = s;
                        video.srcObject = stream;
                    })
                    .catch(err => {
                        console.error("Camera Error:", err);
                        addBotMessage("Could not access the camera. Please check permissions and try again.", true);
                        cleanup();
                    });
            } else {
                addBotMessage("Your browser does not support camera access.", true);
                cleanup();
                return;
            }
            cancelButton.onclick = cleanup;
            snapButton.onclick = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg');
                imagePreview.src = dataUrl;
                userData.base64Image = dataUrl.split(',')[1]; 
                updateVisualPanel('image-preview');
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                proceedToNextStep('Photo from camera', 'Photo from camera');
            };
        }
        function renderResult(result) {
            const container = document.createElement('div');
            container.className = 'flex items-start gap-3 chat-bubble-wrapper self-start';
            const avatar = document.createElement('img');
            avatar.src = 'avatar.svg';
            avatar.alt = 'bot avatar';
            avatar.className = 'w-10 h-10 rounded-full border-2 border-purple-100';
            avatar.onerror = () => { avatar.style.display = 'none'; };
            const resultContainer = document.createElement('div');
            resultContainer.className = 'text-center bot-bubble max-w-md p-4 rounded-2xl rounded-bl-lg';
            resultContainer.innerHTML = `<h2 class="text-2xl font-bold tracking-tight">Your Result:</h2><p class="text-8xl font-extrabold logo-gradient-text my-4">${result.score}</p><p class="text-gray-600 text-lg">${result.rank}</p><button onclick="location.reload()" class="cta-button font-bold text-lg px-8 py-3 rounded-xl mt-8">Try Again</button>`;
            container.appendChild(avatar);
            container.appendChild(resultContainer);
            chatLog.appendChild(container);
            scrollToBottom();
        }
        
        checkPaymentStatus().then(() => {
            if (currentStep === 0 && !new URLSearchParams(window.location.search).has("payment_intent_client_secret")) {
                handleStep();
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Get Your Score - Global Beauty Rank</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F7F7F8; overflow: hidden; }
        .logo-gradient-text { background: linear-gradient(90deg, #D946EF, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .cta-button { background: linear-gradient(90deg, #D946EF, #8B5CF6); color: white; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .cta-button:hover { box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.5), 0 0 15px rgba(217, 70, 239, 0.3); transform: translateY(-3px) scale(1.05); }
        .cta-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        #visual-panel { background: linear-gradient(135deg, #f5f3ff 0%, #eef2ff 100%); }
        .visual-content { transition: opacity 0.5s ease-in-out; position: absolute; }
        .chat-bubble-wrapper { animation: fadeIn 0.5s ease-in-out forwards; }
        .bot-bubble { background-color: #eef2ff; color: #4338ca; }
        .user-bubble { background: linear-gradient(90deg, #D946EF, #8B5CF6); color: white; }
        .input-option:hover { background-color: #f5f3ff; border-color: #8B5CF6; }
        .input-option.selected { border-color: #8B5CF6; background-color: #F5F3FF; color: #6D28D9; box-shadow: 0 0 0 2px #C4B5FD; }
        .country-option:hover { background-color: #f5f3ff; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes typing { 0% { content: "."; } 33% { content: ".."; } 66% { content: "..."; } 100% { content: "."; } }
        .typing-indicator::after { content: '.'; animation: typing 1.5s infinite; }
    </style>
</head>
<body class="text-gray-900">
    <main class="w-screen h-screen grid grid-cols-1 md:grid-cols-2">
        <!-- Left Visual Panel -->
        <div id="visual-panel" class="hidden md:flex items-center justify-center p-8 relative overflow-hidden">
            <div id="visual-welcome" class="visual-content text-center opacity-100"><img src="welcome.svg" alt="Welcome Illustration" class="w-[34rem] h-[34rem] mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/544x544/E9D5FF/4C1D95?text=Welcome';"><h2 class="text-3xl font-bold text-gray-700">Global Beauty Rank</h2><p class="text-gray-500 mt-2">Discover your beauty score with our AI.</p></div>
            <div id="visual-data" class="visual-content text-center opacity-0 hidden"><img src="data-form.svg" alt="Data Input Illustration" class="w-[34rem] h-[34rem] mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/544x544/E9D5FF/4C1D95?text=Data';"><h2 class="text-3xl font-bold text-gray-700">Just a few questions...</h2><p class="text-gray-500 mt-2">This will help us determine your score more accurately.</p></div>
            <div id="visual-upload" class="visual-content text-center opacity-0 hidden"><img src="selfie-upload.svg" alt="Upload Selfie Illustration" class="w-[34rem] h-[34rem] mx-auto mb-4" onerror="this.onerror=null;this.src='https://placehold.co/544x544/E9D5FF/4C1D95?text=Upload';"><h2 class="text-3xl font-bold text-gray-700">Time for a selfie!</h2><p class="text-gray-500 mt-2">Upload a photo where your face is clearly visible.</p></div>
            <img id="image-preview" class="visual-content max-h-full max-w-full object-contain rounded-2xl shadow-lg opacity-0 hidden" />
        </div>
        <!-- Right Chat Panel -->
        <div class="w-full h-screen flex flex-col bg-white">
            <div class="p-4 border-b border-gray-200"><div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-bar-fill" class="bg-gradient-to-r from-pink-500 to-purple-500 h-2.5 rounded-full transition-width duration-500" style="width: 0%"></div></div></div>
            <div id="chat-log" class="flex-grow p-6 space-y-6 overflow-y-auto"></div>
            <div id="input-area" class="p-4 border-t border-gray-200 bg-gray-50"></div>
        </div>
    </main>

    <script type="module">
        // Импортируем Firebase, так как он нужен для записи в базу
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ВАЖНО: Вставьте сюда вашу конфигурацию Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD9R43D9ktWxYFQtpkGJNTOgdWyZqfM-bU",
            authDomain: "global-beauty-rank.firebaseapp.com",
            projectId: "global-beauty-rank",
            storageBucket: "global-beauty-rank.firebasestorage.app",
            messagingSenderId: "916586590476",
            appId: "1:916586590476:web:039be613c177dc46491929",
            measurementId: "G-6KPWTDXMHF"
        };
        
        // Инициализируем Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ВАЖНО: Вставьте сюда ваш ПУБЛИКУЕМЫЙ ключ от Stripe (pk_live_51PQ7mLA19LNOHDEO1yMYpJ3B74vO6GdJD0No0qRpsDBo5Xw956DxQMayJWUZjlNEo6S1WdEWY2Hr6ysFkLI4386I00vkmegPBL)
        const STRIPE_PUBLISHABLE_KEY = "pk_live_YOUR_PUBLISHABLE_KEY";

        // URL-адреса ведут на Netlify Functions
        const createPaymentIntentUrl = "/.netlify/functions/createPaymentIntent";
        const analyzeImageUrl = "/.netlify/functions/analyzeImage";

        const chatLog = document.getElementById('chat-log');
        const inputArea = document.getElementById('input-area');
        const progressBarFill = document.getElementById('progress-bar-fill');
        const imagePreview = document.getElementById('image-preview');

        let currentStep = 0;
        const userData = { base64Image: null };
        let stripe, elements, cardElement;

        const countries = ["Andorra", "United Arab Emirates", "Afghanistan", "Antigua and Barbuda", "Anguilla", "Albania", "Armenia", "Angola", "Antarctica", "Argentina", "American Samoa", "Austria", "Australia", "Aruba", "Åland Islands", "Azerbaijan", "Bosnia and Herzegovina", "Barbados", "Bangladesh", "Belgium", "Burkina Faso", "Bulgaria", "Bahrain", "Burundi", "Benin", "Saint Barthélemy", "Bermuda", "Brunei", "Bolivia", "Caribbean Netherlands", "Brazil", "Bahamas", "Bhutan", "Bouvet Island", "Botswana", "Belarus", "Belize", "Canada", "Cocos (Keeling) Islands", "DR Congo", "Central African Republic", "Republic of the Congo", "Switzerland", "Côte d'Ivoire (Ivory Coast)", "Cook Islands", "Chile", "Cameroon", "China", "Colombia", "Costa Rica", "Cuba", "Cape Verde", "Curaçao", "Christmas Island", "Cyprus", "Czechia", "Germany", "Djibouti", "Denmark", "Dominica", "Dominican Republic", "Algeria", "Ecuador", "Estonia", "Egypt", "Western Sahara", "Eritrea", "Spain", "Ethiopia", "Finland", "Fiji", "Falkland Islands", "Micronesia", "Faroe Islands", "France", "Gabon", "United Kingdom", "Grenada", "Georgia", "French Guiana", "Guernsey", "Ghana", "Gibraltar", "Greenland", "Gambia", "Guinea", "Guadeloupe", "Equatorial Guinea", "Greece", "South Georgia", "Guatemala", "Guam", "Guinea-Bissau", "Guyana", "Hong Kong", "Heard Island and McDonald Islands", "Honduras", "Croatia", "Haiti", "Hungary", "Indonesia", "Ireland", "Israel", "Isle of Man", "India", "British Indian Ocean Territory", "Iraq", "Iran", "Iceland", "Italy", "Jersey", "Jamaica", "Jordan", "Japan", "Kenya", "Kyrgyzstan", "Cambodia", "Kiribati", "Comoros", "Saint Kitts and Nevis", "North Korea", "South Korea", "Kuwait", "Cayman Islands", "Kazakhstan", "Laos", "Lebanon", "Saint Lucia", "Liechtenstein", "Sri Lanka", "Liberia", "Lesotho", "Lithuania", "Luxembourg", "Latvia", "Libya", "Morocco", "Monaco", "Moldova", "Montenegro", "Saint Martin", "Madagascar", "Marshall Islands", "North Macedonia", "Mali", "Myanmar", "Mongolia", "Macau", "Northern Mariana Islands", "Martinique", "Mauritania", "Montserrat", "Malta", "Mauritius", "Maldives", "Malawi", "Mexico", "Malaysia", "Mozambique", "Namibia", "New Caledonia", "Niger", "Norfolk Island", "Nigeria", "Nicaragua", "Netherlands", "Norway", "Nepal", "Nauru", "Niue", "New Zealand", "Oman", "Panama", "Peru", "French Polynesia", "Papua New Guinea", "Philippines", "Pakistan", "Poland", "Saint Pierre and Miquelon", "Pitcairn Islands", "Puerto Rico", "Palestine", "Portugal", "Palau", "Paraguay", "Qatar", "Réunion", "Romania", "Serbia", "Russia", "Rwanda", "Saudi Arabia", "Solomon Islands", "Seychelles", "Sudan", "Sweden", "Singapore", "Saint Helena Ascension and Tristan da Cunha", "Slovenia", "Svalbard and Jan Mayen", "Slovakia", "Sierra Leone", "San Marino", "Senegal", "Somalia", "Suriname", "South Sudan", "São Tomé and Príncipe", "El Salvador", "Sint Maarten", "Syria", "Eswatini (Swaziland)", "Turks and Caicos Islands", "Chad", "French Southern and Antarctic Lands", "Togo", "Thailand", "Tajikistan", "Tokelau", "Timor-Leste", "Turkmenistan", "Tunisia", "Tonga", "Turkey", "Trinidad and Tobago", "Tuvalu", "Taiwan", "Tanzania", "Ukraine", "Uganda", "United States Minor Outlying Islands", "United States", "Uruguay", "Uzbekistan", "Vatican City (Holy See)", "Saint Vincent and the Grenadines", "Venezuela", "British Virgin Islands", "United States Virgin Islands", "Vietnam", "Vanuatu", "Wallis and Futuna", "Samoa", "Kosovo", "Yemen", "Mayotte", "South Africa", "Zambia", "Zimbabwe"];

        const quizSteps = [
            { id: 'welcome', type: 'message', text: "Hello! I'm your personal AI assistant. Ready to discover your beauty score?" },
            { id: 'privacy', type: 'message', text: "Great! But first, something important: your photos are only used for analysis and are deleted immediately after calculation. Your privacy is guaranteed." },
            { id: 'disclaimer', type: 'choice', text: "And remember: this score is the result of an algorithm, not a verdict. Everyone is beautiful in their own way. Do you agree?", options: [{ text: 'I understand and agree', value: 'agree' }] },
            { id: 'terms', type: 'choice', text: 'Please review our <a href="terms.html" target="_blank" class="underline text-indigo-500 hover:text-indigo-400">Terms of Service</a> and <a href="policy.html" target="_blank" class="underline text-indigo-500 hover:text-indigo-400">Privacy Policy</a> before we continue.', options: [{ text: 'I agree and continue', value: 'agree' }] },
            { id: 'name', type: 'text', text: "Perfect! Let's get started. What's your name?" },
            { id: 'name_greeting', type: 'message', text: 'Nice to meet you, ' },
            { id: 'country', type: 'searchable-select', text: 'What country are you from?', options: countries },
            { id: 'gender', type: 'choice', text: "Got it. Now, please select your gender.", options: [{ text: 'Male', value: 'male' }, { text: 'Female', value: 'female' }] },
            { id: 'age', type: 'select', text: "Thank you. And your age range?", options: ['Under 18', '18-25', '25-35', '36-44', '45-59', '60+'] },
            { id: 'upload', type: 'file', text: "Super! Now, please upload your best selfie. Make sure your face is clearly visible, without glasses or heavy makeup." },
            { id: 'upload_compliment', type: 'message', text: 'Wow, you are very beautiful! Now for the final step.' },
            { id: 'payment', type: 'payment', text: 'Almost done. The last step is a secure payment.' },
            { id: 'calculating', type: 'message', text: "Thank you! Sending your photo to the neural network for analysis... This may take a few seconds." },
            { id: 'result', type: 'result' }
        ];
        
        // Эта функция теперь делает все: получает оценку и записывает в базу
        async function getAIScore() {
            if (!userData.base64Image) {
                await addBotMessage("It seems there was an error with the photo upload. Please try again.", true);
                return;
            }
            
            try {
                // 1. Получаем оценку от Netlify Function
                const response = await fetch(analyzeImageUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Отправляем только изображение
                    body: JSON.stringify({ image: userData.base64Image })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Function Error: ${response.statusText} - ${errorData.error}`);
                }

                const aiResult = await response.json();
                
                // 2. Записываем результат в Firestore прямо из браузера
                try {
                    await addDoc(collection(db, "rankings"), {
                        name: userData.name || 'Anonymous',
                        country: userData.country || 'Unknown',
                        gender: userData.gender || 'Not specified',
                        age: userData.age || 'Not specified',
                        score: parseFloat(aiResult.score) || 0,
                        timestamp: serverTimestamp()
                    });
                } catch (dbError) {
                    console.error("Firestore write error:", dbError);
                    // Не показываем ошибку пользователю, т.к. он уже получил результат
                }

                // 3. Показываем результат пользователю
                renderResult(aiResult);

            } catch (error) {
                console.error("AI Score Error:", error);
                await addBotMessage("Unfortunately, the AI analyzer is not responding right now. Please try again a little later.", true);
                renderResult({score: '?', rank: 'Analysis Error'});
            }
        }
        
        async function renderPayment() {
            const container = document.createElement('div');
            container.className = 'flex items-start gap-3 chat-bubble-wrapper self-start';
            const avatar = document.createElement('img');
            avatar.src = 'avatar.svg';
            avatar.alt = 'bot avatar';
            avatar.className = 'w-10 h-10 rounded-full border-2 border-purple-100';
            avatar.onerror = () => { avatar.style.display = 'none'; };
            const paymentBubble = document.createElement('div');
            paymentBubble.className = 'bot-bubble max-w-md p-4 sm:p-6 rounded-2xl rounded-bl-lg w-full';
            const form = document.createElement('form');
            form.id = 'payment-form';
            form.innerHTML = `<div class="flex justify-between items-start"><div><h3 class="font-bold text-lg text-indigo-800">Special offer</h3><p class="text-sm text-indigo-700">NOW ONLY FOR YOU</p></div><div class="text-right"><p class="text-gray-400 line-through">$15.00</p><p class="text-2xl font-bold text-indigo-800">$4.50</p></div></div><div class="my-4 flex justify-center"><img src="payment.svg" alt="Payment methods" class="h-24" onerror="this.onerror=null;this.src='https://placehold.co/250x50/FFFFFF/333333?text=VISA+Mastercard+Amex';"></div><div id="card-element" class="bg-white p-3 rounded-lg border border-indigo-200"></div><div id="card-errors" role="alert" class="text-red-500 text-sm mt-2 h-4"></div><button id="submit-payment" class="w-full mt-4 cta-button font-bold text-lg px-8 py-3 rounded-xl"><span>Pay $4.50 and get result</span></button>`;
            paymentBubble.appendChild(form);
            container.appendChild(avatar);
            container.appendChild(paymentBubble);
            chatLog.appendChild(container);
            scrollToBottom();

            try {
                stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
                const response = await fetch(createPaymentIntentUrl, { method: 'POST' });
                const { clientSecret } = await response.json();
                
                elements = stripe.elements({ clientSecret });
                cardElement = elements.create('card');
                cardElement.mount('#card-element');
                cardElement.on('change', (event) => {
                    document.getElementById('card-errors').textContent = event.error ? event.error.message : '';
                });
            } catch (error) {
                console.error("Error initializing payment:", error);
                addBotMessage("Could not initialize payment. Please check your configuration and try again later.", true);
            }


            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = document.getElementById('submit-payment');
                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="animate-spin h-5 w-5 mx-auto border-2 border-white border-t-transparent rounded-full"></div>`;
                
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                        return_url: window.location.href, 
                    },
                    redirect: 'if_required'
                });

                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    submitButton.disabled = false;
                    submitButton.innerHTML = `<span>Pay $4.50 and get result</span>`;
                } else {
                    proceedToNextStep({ payment: 'success' }, 'Payment successful');
                }
            });
        }
        
        function updateVisualPanel(stepId) {
            document.querySelectorAll('.visual-content').forEach(el => {
                el.classList.add('opacity-0', 'hidden');
            });
            imagePreview.classList.add('opacity-0', 'hidden');
            let activeVisualId;
            if (['welcome', 'privacy', 'disclaimer', 'terms'].includes(stepId)) {
                activeVisualId = 'visual-welcome';
            } else if (['name', 'country', 'gender', 'age'].includes(stepId)) {
                activeVisualId = 'visual-data';
            } else if (stepId === 'upload') {
                activeVisualId = 'visual-upload';
            } else {
                activeVisualId = 'image-preview';
            }
            const activeVisual = document.getElementById(activeVisualId);
            if (activeVisual) {
                activeVisual.classList.remove('hidden');
                setTimeout(() => {
                    activeVisual.classList.remove('opacity-0');
                }, 10);
            }
        }
        function updateProgress() {
            const percent = (currentStep / (quizSteps.length - 1)) * 100;
            progressBarFill.style.width = `${percent}%`;
        }
        function scrollToBottom() {
            setTimeout(() => {
                chatLog.scrollTop = chatLog.scrollHeight;
            }, 0);
        }
        function showTypingIndicator() {
            const container = document.createElement('div');
            container.id = 'typing-indicator';
            container.className = 'flex items-start gap-3 chat-bubble-wrapper self-start';
            container.innerHTML = `<img src="avatar.svg" alt="bot avatar" class="w-10 h-10 rounded-full border-2 border-purple-100" onerror="this.style.display='none'"><div class="bot-bubble p-3 rounded-2xl rounded-bl-lg"><div class="typing-indicator"></div></div>`;
            chatLog.appendChild(container);
            scrollToBottom();
        }
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }
        function disableInputs() {
            inputArea.innerHTML = '';
        }
        function addBotMessage(text, isError = false) {
            return new Promise(resolve => {
                showTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();
                    const container = document.createElement('div');
                    container.className = 'flex items-start gap-3 chat-bubble-wrapper self-start';
                    const avatar = document.createElement('img');
                    avatar.src = 'avatar.svg';
                    avatar.alt = 'bot avatar';
                    avatar.className = 'w-10 h-10 rounded-full border-2 border-purple-100';
                    avatar.onerror = () => { avatar.style.display = 'none'; };
                    const bubble = document.createElement('div');
                    bubble.className = `bot-bubble max-w-md p-4 rounded-2xl rounded-bl-lg text-lg ${isError ? 'bg-red-100 text-red-700' : ''}`;
                    bubble.innerHTML = text;
                    container.appendChild(avatar);
                    container.appendChild(bubble);
                    chatLog.appendChild(container);
                    scrollToBottom();
                    resolve();
                }, 1000 + Math.random() * 500);
            });
        }
        function addUserMessage(text) {
             const bubble = document.createElement('div');
             bubble.className = 'user-bubble self-end max-w-md p-4 rounded-2xl rounded-br-lg text-lg chat-bubble-wrapper';
             bubble.textContent = text;
             chatLog.appendChild(bubble);
             scrollToBottom();
        }
        async function handleStep() {
            if (currentStep >= quizSteps.length) return;
            updateProgress();
            const step = quizSteps[currentStep];
            disableInputs();
            updateVisualPanel(step.id);
            if (step.type === 'result') {
                await getAIScore();
                return;
            }
            let messageText = step.text;
            if (step.id === 'name_greeting') {
                messageText = `${step.text}${userData.name}!`;
            }
            await addBotMessage(messageText);
            switch (step.type) {
                case 'choice': renderChoices(step.options); break;
                case 'select': renderSelect(step.options); break;
                case 'searchable-select': renderSearchableSelect(step.options); break;
                case 'text': renderTextInput(); break;
                case 'file': renderFileUpload(); break;
                case 'payment': renderPayment(); break;
                case 'message': default: currentStep++; setTimeout(handleStep, 500); break;
            }
        }
        function proceedToNextStep(data, displayText) {
            const step = quizSteps[currentStep];
            userData[step.id] = data;
            if (displayText) {
                addUserMessage(displayText);
            }
            currentStep++;
            setTimeout(handleStep, 500);
        }
        function renderChoices(options) {
            const container = document.createElement('div');
            container.className = 'flex flex-wrap gap-3 justify-center';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'input-option bg-white border-2 border-gray-300 rounded-lg px-6 py-3 font-semibold text-gray-700';
                button.textContent = option.text;
                button.onclick = () => {
                    document.querySelectorAll('.input-option').forEach(btn => btn.disabled = true);
                    button.classList.add('selected');
                    proceedToNextStep(option.value, option.text);
                };
                container.appendChild(button);
            });
            inputArea.appendChild(container);
        }
        function renderSelect(options) {
            const select = document.createElement('select');
            select.className = 'w-full p-4 border border-gray-300 rounded-lg text-lg bg-white focus:ring-2 focus:ring-purple-400 focus:border-purple-400';
            const placeholder = document.createElement('option');
            placeholder.value = "";
            placeholder.textContent = "Select...";
            placeholder.disabled = true;
            placeholder.selected = true;
            select.appendChild(placeholder);
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                select.appendChild(opt);
            });
            select.onchange = () => {
                if (select.value) {
                    proceedToNextStep(select.value, select.value);
                }
            };
            inputArea.appendChild(select);
        }
        function renderSearchableSelect(options) {
            const container = document.createElement('div');
            container.className = 'w-full';
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search for a country...';
            searchInput.className = 'w-full p-4 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400 mb-2';
            const resultsContainer = document.createElement('div');
            resultsContainer.className = 'bg-white border border-gray-300 rounded-lg max-h-48 overflow-y-auto';
            const populateList = (filter = '') => {
                resultsContainer.innerHTML = '';
                const filteredOptions = options.filter(opt => opt.toLowerCase().includes(filter.toLowerCase()));
                if (filteredOptions.length === 0) {
                    const noResult = document.createElement('div');
                    noResult.className = 'p-3 text-gray-500';
                    noResult.textContent = 'No results found';
                    resultsContainer.appendChild(noResult);
                } else {
                    filteredOptions.forEach(option => {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'p-3 cursor-pointer country-option transition-colors';
                        optionEl.textContent = option;
                        optionEl.onclick = () => {
                            proceedToNextStep(option, option);
                        };
                        resultsContainer.appendChild(optionEl);
                    });
                }
            };
            searchInput.oninput = () => {
                populateList(searchInput.value);
            };
            container.appendChild(searchInput);
            container.appendChild(resultsContainer);
            inputArea.appendChild(container);
            populateList();
            searchInput.focus();
        }
        function renderTextInput() {
            const form = document.createElement('form');
            form.className = 'flex gap-2';
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Enter your name...';
            input.className = 'w-full p-4 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400';
            input.required = true;
            const button = document.createElement('button');
            button.type = 'submit';
            button.className = 'cta-button font-bold text-lg px-6 py-3 rounded-xl';
            button.textContent = 'Next';
            form.appendChild(input);
            form.appendChild(button);
            form.onsubmit = (e) => {
                e.preventDefault();
                const name = input.value.trim();
                if (name) {
                    proceedToNextStep(name, name);
                }
            };
            inputArea.appendChild(form);
            input.focus();
        }
        function renderFileUpload() {
            const container = document.createElement('div');
            container.className = 'grid sm:grid-cols-2 gap-3';
            const uploadLabel = document.createElement('label');
            uploadLabel.htmlFor = 'selfie-upload';
            uploadLabel.className = 'w-full cta-button font-bold text-lg px-6 py-4 rounded-xl inline-flex items-center justify-center cursor-pointer';
            uploadLabel.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg> Upload Photo`;
            const cameraButton = document.createElement('button');
            cameraButton.className = 'w-full bg-white border-2 border-gray-300 rounded-lg px-6 py-4 font-semibold text-gray-700 inline-flex items-center justify-center';
            cameraButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Open Camera`;
            cameraButton.onclick = openCamera;
            const fileInput = document.createElement('input');
            fileInput.id = 'selfie-upload';
            fileInput.type = 'file';
            fileInput.className = 'hidden';
            fileInput.accept = 'image/*';
            fileInput.onchange = () => {
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        userData.base64Image = e.target.result.split(',')[1]; 
                        updateVisualPanel('image-preview');
                    }
                    reader.readAsDataURL(fileInput.files[0]);
                    proceedToNextStep(fileInput.files[0], fileInput.files[0].name);
                }
            };
            container.appendChild(uploadLabel);
            container.appendChild(cameraButton);
            inputArea.appendChild(container);
            inputArea.appendChild(fileInput);
        }
        function openCamera() {
            disableInputs();
            const videoContainer = document.createElement('div');
            videoContainer.className = 'relative w-full aspect-video bg-black rounded-lg overflow-hidden';
            videoContainer.innerHTML = `<video id="camera-feed" class="w-full h-full object-cover" autoplay playsinline></video><canvas id="camera-canvas" class="hidden"></canvas>`;
            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'grid grid-cols-2 gap-3 mt-2';
            const snapButton = document.createElement('button');
            snapButton.className = 'w-full cta-button font-bold text-lg px-6 py-4 rounded-xl';
            snapButton.textContent = 'Take Photo';
            const cancelButton = document.createElement('button');
            cancelButton.className = 'w-full bg-gray-200 text-gray-700 font-bold text-lg px-6 py-4 rounded-xl';
            cancelButton.textContent = 'Cancel';
            controlsContainer.appendChild(cancelButton);
            controlsContainer.appendChild(snapButton);
            inputArea.appendChild(videoContainer);
            inputArea.appendChild(controlsContainer);
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('camera-canvas');
            let stream = null;
            const cleanup = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                renderFileUpload();
            };
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                    .then(s => {
                        stream = s;
                        video.srcObject = stream;
                    })
                    .catch(err => {
                        console.error("Camera Error:", err);
                        addBotMessage("Could not access the camera. Please check permissions and try again.", true);
                        cleanup();
                    });
            } else {
                addBotMessage("Your browser does not support camera access.", true);
                cleanup();
                return;
            }
            cancelButton.onclick = cleanup;
            snapButton.onclick = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg');
                imagePreview.src = dataUrl;
                userData.base64Image = dataUrl.split(',')[1]; 
                updateVisualPanel('image-preview');
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                proceedToNextStep('Photo from camera', 'Photo from camera');
            };
        }
        function renderResult(result) {
            const container = document.createElement('div');
            container.className = 'flex items-start gap-3 chat-bubble-wrapper self-start';
            const avatar = document.createElement('img');
            avatar.src = 'avatar.svg';
            avatar.alt = 'bot avatar';
            avatar.className = 'w-10 h-10 rounded-full border-2 border-purple-100';
            avatar.onerror = () => { avatar.style.display = 'none'; };
            const resultContainer = document.createElement('div');
            resultContainer.className = 'text-center bot-bubble max-w-md p-4 rounded-2xl rounded-bl-lg';
            resultContainer.innerHTML = `<h2 class="text-2xl font-bold tracking-tight">Your Result:</h2><p class="text-8xl font-extrabold logo-gradient-text my-4">${result.score}</p><p class="text-gray-600 text-lg">${result.rank}</p><button onclick="location.reload()" class="cta-button font-bold text-lg px-8 py-3 rounded-xl mt-8">Try Again</button>`;
            container.appendChild(avatar);
            container.appendChild(resultContainer);
            chatLog.appendChild(container);
            scrollToBottom();
        }
        handleStep();
    </script>
</body>
</html>
